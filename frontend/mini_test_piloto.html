<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaming Performance Test - Estudio Piloto</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÆ Gaming Performance Mini-Test</h1>
            <p>Completa las 3 pruebas para obtener tus m√©tricas</p>
        </header>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar">
                <div id="progress" class="progress-fill"></div>
            </div>
            <p id="progress-text">Paso 1 de 4</p>
        </div>

        <!-- Paso 1: Selecci√≥n de juego -->
        <div id="step-1" class="step active">
            <h2>Paso 1: Selecciona tu juego principal</h2>
            <select id="game-select" class="game-select">
                <option value="">-- Selecciona un juego --</option>
                <option value="valorant">Valorant</option>
                <option value="csgo">CS:GO / CS2</option>
                <option value="fortnite">Fortnite</option>
                <option value="warzone">Call of Duty Warzone</option>
            </select>
            <button onclick="nextStep()" class="btn btn-primary">Continuar</button>
        </div>

        <!-- Paso 2: Reaction Time Test -->
        <div id="step-2" class="step">
            <h2>Paso 2: Test de Tiempo de Reacci√≥n</h2>
            <p>Haz clic lo m√°s r√°pido posible cuando la pantalla cambie de color</p>
            
            <div id="reaction-container" class="test-container">
                <div id="reaction-box" class="reaction-box waiting">
                    <p id="reaction-text">Haz clic para comenzar</p>
                </div>
            </div>

            <div id="reaction-stats" class="stats hidden">
                <p>Intentos: <span id="reaction-attempts">0</span>/10</p>
                <p>Promedio: <span id="reaction-avg">-</span> ms</p>
                <p>√öltimo:  <span id="reaction-last">-</span> ms</p>
            </div>

            <button id="next-after-reaction" onclick="nextStep()" class="btn btn-primary hidden">
                Continuar al Test de Punter√≠a
            </button>
        </div>

        <!-- Paso 3: Aim Test -->
        <div id="step-3" class="step">
            <h2>Paso 3: Test de Punter√≠a</h2>
            <p>Haz clic en los objetivos lo m√°s r√°pido y preciso posible (30 segundos)</p>
            
            <div id="aim-stats" class="stats">
                <p>Tiempo: <span id="aim-timer">30</span>s</p>
                <p>Aciertos: <span id="aim-hits">0</span></p>
                <p>Fallos: <span id="aim-misses">0</span></p>
            </div>

            <div id="aim-container" class="aim-container">
                <button id="start-aim" onclick="startAimTest()" class="btn btn-secondary">
                    Comenzar Test
                </button>
            </div>

            <button id="next-after-aim" onclick="nextStep()" class="btn btn-primary hidden">
                Continuar al Test de Clics
            </button>
        </div>

        <!-- Paso 4: Click Speed Test -->
        <div id="step-4" class="step">
            <h2>Paso 4: Test de Velocidad de Clics</h2>
            <p>Haz clic lo m√°s r√°pido posible durante 10 segundos</p>
            
            <div id="click-stats" class="stats">
                <p>Tiempo: <span id="click-timer">10</span>s</p>
                <p>Clics: <span id="click-count">0</span></p>
                <p>CPM: <span id="click-cpm">0</span></p>
            </div>

            <div id="click-container" class="test-container">
                <div id="click-box" class="click-box">
                    <button id="start-click" onclick="startClickTest()" class="btn btn-large">
                        Comenzar Test
                    </button>
                </div>
            </div>

            <button id="submit-results" onclick="submitResults()" class="btn btn-success hidden">
                Ver Resultados
            </button>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Procesando resultados...</p>
        </div>
    </div>

    <script src="js/reaction_test.js"></script>
    <script src="js/aim_test.js"></script>
    <script src="js/click_test.js"></script>
    <script>
        // State management
        let currentStep = 1;
        let selectedGame = '';
        let testResults = {
            reaction_times: [],
            aim_results: {},
            click_test:  {}
        };

        function nextStep() {
            // Validaciones
            if (currentStep === 1) {
                selectedGame = document.getElementById('game-select').value;
                if (! selectedGame) {
                    alert('Por favor selecciona un juego');
                    return;
                }
            }

            if (currentStep === 2 && testResults.reaction_times.length < 10) {
                alert('Completa las 10 rondas del test de reacci√≥n');
                return;
            }

            if (currentStep === 3 && ! testResults.aim_results. hits) {
                alert('Completa el test de punter√≠a');
                return;
            }

            if (currentStep === 4 && !testResults.click_test. clicks) {
                alert('Completa el test de clics');
                return;
            }

            // Ocultar step actual
            document.getElementById(`step-${currentStep}`).classList.remove('active');
            
            // Mostrar siguiente step
            currentStep++;
            if (currentStep <= 4) {
                document. getElementById(`step-${currentStep}`).classList.add('active');
                updateProgress();
            }
        }

        function updateProgress() {
            const progress = (currentStep / 4) * 100;
            document.getElementById('progress').style.width = progress + '%';
            document.getElementById('progress-text').textContent = `Paso ${currentStep} de 4`;
        }

        function submitResults() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('submit-results').classList.add('hidden');

            // Calcular duraci√≥n total
            const totalDuration = (
                (testResults.reaction_test_duration || 0) +
                (testResults.aim_test_duration || 0) +
                (testResults.click_test_duration || 0)
            );

            testResults.total_duration = totalDuration;

            // Calcular m√©tricas
            setTimeout(() => {
                mostrarResultados();
            }, 1000);
        }

        function mostrarResultados() {
            const reactionTimes = testResults.reaction_times;
            const aimResults = testResults.aim_results;
            const clickTest = testResults.click_test;
            
            const metrics = {
                reaction_ms_mean: (reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length).toFixed(2),
                reaction_ms_std: calculateStd(reactionTimes).toFixed(2),
                false_starts: testResults.false_starts || 0,
                aim_accuracy: (aimResults.hits / (aimResults.hits + aimResults.misses)).toFixed(4),
                mean_time_to_hit_ms: (aimResults.times_to_hit. reduce((a, b) => a + b, 0) / aimResults.times_to_hit.length).toFixed(2),
                miss_rate: (aimResults.misses / (aimResults.hits + aimResults.misses)).toFixed(4),
                cpm: ((clickTest.clicks / clickTest.duration) * 60).toFixed(2),
                error_rate: (clickTest.errors / clickTest.clicks).toFixed(4),
                test_duration_s: testResults. total_duration. toFixed(2)
            };

            const participantId = 'P' + Date.now().toString().slice(-6);
            const csvRow = `${participantId},${new Date().toISOString().split('T')[0]},${selectedGame},RANGO_PENDIENTE,${metrics.reaction_ms_mean},${metrics.reaction_ms_std},${metrics.false_starts},${metrics.aim_accuracy},${metrics.mean_time_to_hit_ms},${metrics.miss_rate},${metrics.cpm},${metrics.error_rate},${metrics.test_duration_s}`;

            // Guardar en localStorage
            localStorage.setItem('testData', csvRow);
            localStorage.setItem('participantId', participantId);

            document.getElementById('loading').classList.add('hidden');
            
            const container = document.querySelector('.container');
            container.innerHTML = `
                <header>
                    <h1>‚úÖ ¬°Test Completado!</h1>
                    <p>Solo un paso m√°s... </p>
                </header>

                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 40px; border-radius: 12px; text-align: center; margin:  20px 0;">
                    <h2 style="font-size: 2.5rem; margin:  0;">üéâ ¬°Excelente! </h2>
                    <p style="font-size: 1.2rem; margin-top: 15px; opacity: 0.95;">
                        Tu informaci√≥n ha sido procesada correctamente
                    </p>
                </div>

                <div style="background: #f8fafc; padding: 30px; border-radius: 12px; margin:  20px 0;">
                    <h2 style="margin-bottom: 20px;">üìä Resumen de Resultados: </h2>
                    
                    <div style="display:  grid; grid-template-columns:  repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #6366f1;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 5px;">Tiempo Reacci√≥n</div>
                            <div style="font-size: 1.8rem; font-weight: 700; color: #1e293b;">${metrics.reaction_ms_mean} <span style="font-size: 1rem; color: #94a3b8;">ms</span></div>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 5px;">Punter√≠a</div>
                            <div style="font-size:  1.8rem; font-weight: 700; color: #1e293b;">${(metrics.aim_accuracy * 100).toFixed(1)}<span style="font-size: 1rem; color: #94a3b8;">%</span></div>
                        </div>
                        
                        <div style="background: white; padding:  20px; border-radius:  8px; border-left:  4px solid #ec4899;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 5px;">Clics/Min</div>
                            <div style="font-size: 1.8rem; font-weight: 700; color: #1e293b;">${metrics.cpm}</div>
                        </div>
                    </div>
                </div>

                <div style="background: #dbeafe; padding: 25px; border-radius: 12px; border-left: 4px solid #3b82f6; margin:  20px 0;">
                    <h3 style="margin:  0 0 15px 0; color: #1e40af;">üìù √öltimo Paso (15 segundos)</h3>
                    <p style="margin:  0 0 20px 0; color: #1e293b; line-height: 1.6;">
                        Para completar tu participaci√≥n, necesitamos verificar tu <strong>rango actual</strong> en <strong>${selectedGame. toUpperCase()}</strong>.
                        <br><br>
                        Al hacer clic abajo, se abrir√° un formulario donde solo debes: 
                        <br>
                        1Ô∏è‚É£ Escribir tu rango (ej: Gold 2, Platinum, etc.)
                        <br>
                        2Ô∏è‚É£ Subir un screenshot de tu rango (opcional)
                        <br>
                        3Ô∏è‚É£ Enviar
                    </p>
                    <button onclick="abrirFormulario()" class="btn btn-success" style="width: 100%; padding: 18px; font-size: 1.2rem;">
                        üì§ Completar Participaci√≥n (Abrir Formulario)
                    </button>
                </div>

                <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <p style="color: #64748b; font-size: 0.9rem; margin: 0;">
                        ID de tu test: <code style="background: #e2e8f0; padding:  4px 8px; border-radius: 4px; font-family: monospace;">${participantId}</code>
                    </p>
                </div>
            `;
        }

        function abrirFormulario() {
            const csvData = localStorage.getItem('testData');
            
            // IDs de tu Google Form
            const FORM_ID = '1FAIpQLSd54b00WcxsPAQsxoJPaqYd3qyk3TOJ1q6S3A1ZtqhFEcd2tw';
            const ENTRY_ID = '28950858';
            
            const formUrl = `https://docs.google.com/forms/d/e/${FORM_ID}/viewform?usp=pp_url&entry.${ENTRY_ID}=${encodeURIComponent(csvData)}`;
            
            // Abrir formulario
            window.open(formUrl, '_blank');
            
            // Mostrar confirmaci√≥n
            setTimeout(() => {
                if (confirm('‚úÖ Se abri√≥ el formulario en una nueva pesta√±a.\n\n¬øYa completaste y enviaste el formulario?')) {
                    alert('üéâ ¬°Gracias por participar en el estudio!\n\nTus datos ayudar√°n a mejorar la investigaci√≥n sobre gaming performance.');
                    location.reload();
                }
            }, 2000);
        }

        function calculateStd(values) {
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const squareDiffs = values.map(value => Math.pow(value - avg, 2));
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / squareDiffs.length;
            return Math.sqrt(avgSquareDiff);
        }
    </script>
</body>
</html>